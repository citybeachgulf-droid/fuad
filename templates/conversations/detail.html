{% extends 'base.html' %}
{% block title %}المحادثة{% endblock %}
{% block content %}
<div class="container py-4" data-conversation-id="{{ conversation.id }}">
  <div class="d-flex align-items-center justify-content-between mb-3">
    <div>
      <h1 class="h5 mb-1">محادثة مع {{ other_user.name }}</h1>
      <div>
        {% if conversation.status == 'open' %}
          <span class="badge bg-success">مفتوحة</span>
        {% elif conversation.status == 'pending' %}
          <span class="badge bg-warning text-dark">قيد المراجعة</span>
        {% else %}
          <span class="badge bg-secondary">مغلقة</span>
        {% endif %}
      </div>
    </div>
    <div class="d-flex gap-2">
      <a class="btn btn-outline-secondary btn-sm" href="{{ url_for('conversations.list_conversations') }}">رجوع</a>
      {% if current_user.role == 'company' %}
        {% if conversation.status != 'closed' %}
          <button id="closeBtn" class="btn btn-outline-danger btn-sm">إغلاق</button>
        {% endif %}
      {% endif %}
    </div>
  </div>

  <div id="messages" class="border rounded p-3 bg-white" style="max-height: 55vh; overflow-y: auto;">
    {% for m in messages %}
      <div class="mb-3">
        <div class="small text-muted">{{ m.sender.name if m.sender else 'مستخدم' }} • {{ m.timestamp.strftime('%Y-%m-%d %H:%M') }}</div>
        <div class="p-2 rounded {{ 'bg-light' if m.sender_id != current_user.id else 'bg-primary text-white' }}" style="white-space: pre-wrap;">{{ m.content | e }}</div>
      </div>
    {% endfor %}
  </div>

  <div class="mt-3">
    {% if conversation.status == 'closed' %}
      <div class="alert alert-secondary mb-0">هذه المحادثة مغلقة.</div>
    {% else %}
    <form id="sendForm" class="d-flex gap-2">
      <input type="hidden" name="conversation_id" value="{{ conversation.id }}">
      <input id="contentInput" name="content" class="form-control" placeholder="اكتب رسالتك هنا" autocomplete="off" maxlength="3000">
      <button class="btn btn-primary" type="submit">إرسال</button>
    </form>
    <div id="sendAlert" class="mt-2 d-none"></div>
    {% endif %}
  </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
(function() {
  const container = document.querySelector('[data-conversation-id]');
  if (!container) return;
  const convId = container.getAttribute('data-conversation-id');
  const messagesEl = document.getElementById('messages');
  const form = document.getElementById('sendForm');
  const input = document.getElementById('contentInput');
  const closeBtn = document.getElementById('closeBtn');
  const alertEl = document.getElementById('sendAlert');
  let lastTs = null;

  function escapeHtml(str){
    return str.replace(/[&<>"']/g, function(c){ return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[c]); });
  }

  function appendMessage(m) {
    const you = Number(m.sender_id) === Number({{ current_user.id }});
    const wrapper = document.createElement('div');
    wrapper.className = 'mb-3';
    const meta = document.createElement('div');
    meta.className = 'small text-muted';
    meta.textContent = (m.sender_name || 'مستخدم') + ' • ' + new Date(m.timestamp).toLocaleString();
    const body = document.createElement('div');
    body.className = 'p-2 rounded ' + (you ? 'bg-primary text-white' : 'bg-light');
    body.style.whiteSpace = 'pre-wrap';
    body.innerHTML = escapeHtml(m.content);
    wrapper.appendChild(meta);
    wrapper.appendChild(body);
    messagesEl.appendChild(wrapper);
  }

  async function fetchNew() {
    try {
      const url = lastTs ? `/api/conversations/${convId}/messages?since=${encodeURIComponent(lastTs)}` : `/api/conversations/${convId}/messages`;
      const res = await fetch(url, { headers: { 'Accept': 'application/json' } });
      if (!res.ok) return;
      const data = await res.json();
      const items = data.messages || [];
      if (items.length > 0) {
        for (const m of items) appendMessage(m);
        lastTs = items[items.length - 1].timestamp;
        messagesEl.scrollTop = messagesEl.scrollHeight;
      }
    } catch (e) { /* ignore */ }
  }

  async function sendMessage(evt) {
    evt.preventDefault();
    const content = (input.value || '').trim();
    if (!content) return;
    try {
      const res = await fetch('/send_message', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' },
        body: JSON.stringify({ conversation_id: convId, content })
      });
      const data = await res.json();
      if (!res.ok || data.error) {
        alertEl.className = 'alert alert-danger mt-2';
        alertEl.textContent = data.error || 'تعذر إرسال الرسالة';
        return;
      }
      alertEl.className = 'd-none';
      input.value = '';
      appendMessage(data.message);
      lastTs = data.message.timestamp;
      messagesEl.scrollTop = messagesEl.scrollHeight;
    } catch (e) {}
  }

  async function closeConversation() {
    try {
      const res = await fetch(`/conversations/${convId}/status`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded', 'Accept': 'application/json' },
        body: new URLSearchParams({ status: 'closed' })
      });
      const data = await res.json();
      if (res.ok && data.ok) {
        location.reload();
      }
    } catch (e) {}
  }

  if (form) form.addEventListener('submit', sendMessage);
  if (closeBtn) closeBtn.addEventListener('click', closeConversation);

  // initial state
  const existing = messagesEl.querySelectorAll('.mb-3');
  if (existing.length > 0) {
    // infer last timestamp from last server-rendered message meta if needed; we'll just fetch full once
  }
  fetchNew();
  setInterval(fetchNew, 5000);
  messagesEl.scrollTop = messagesEl.scrollHeight;
})();
</script>
{% endblock %}
