{% extends 'base.html' %}

{% block title %}حاسبة القروض{% endblock %}

{% block content %}
<section class="py-5">
    <div class="container">
        <div class="row g-4">
            <div class="col-12">
                <div class="d-flex align-items-center justify-content-between mb-2">
                    <h1 class="h4 mb-0">حاسبة القروض العامة</h1>
                    <a class="btn btn-outline-secondary" href="{{ url_for('main.banks_list') }}">استعرض البنوك</a>
                </div>
                <p class="text-muted mb-4">اختر عرضًا بنكيًا لتطبيق السياسة تلقائيًا، أو أدخل الحقول يدويًا.</p>
            </div>

            <div class="col-lg-7">
                <div class="card shadow-sm">
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-md-12">
                                <label class="form-label">اختر عرض بنك (اختياري)</label>
                                <select id="offerSelect" class="form-select">
                                    <option value="">— بدون اختيار —</option>
                                    {% for o in offers %}
                                    <option value="{{ o.interest_rate }}"
                                            data-min-months="{{ o.min_tenure_months or '' }}"
                                            data-max-months="{{ o.max_tenure_months or '' }}"
                                            data-min-amount="{{ o.min_amount or '' }}"
                                            data-max-amount="{{ o.max_amount or '' }}">
                                        {{ o.bank_profile.user.name }} — {{ o.product_name }} — {{ '%.2f'|format(o.interest_rate) }}%
                                    </option>
                                    {% endfor %}
                                </select>
                                <div class="form-text">سيتم تعبئة النسبة والمدد والحدود حسب سياسة العرض.</div>
                            </div>

                            <div class="col-md-6">
                                <label for="interestRate" class="form-label">النسبة السنوية %</label>
                                <input id="interestRate" type="number" step="0.01" class="form-control" placeholder="مثال: 5.75">
                            </div>
                            <div class="col-md-6">
                                <label for="loanAmount" class="form-label">مبلغ القرض (ر.ع)</label>
                                <input id="loanAmount" type="number" step="0.01" class="form-control" placeholder="مثال: 50000">
                                <div class="form-text" id="amountHint"></div>
                            </div>
                            <div class="col-md-6">
                                <label for="tenureMonths" class="form-label">المدة (بالأشهر)</label>
                                <input id="tenureMonths" type="number" class="form-control" placeholder="مثال: 240">
                                <div class="form-text" id="tenureHint"></div>
                            </div>
                            <div class="col-12">
                                <button id="calcBtn" class="btn btn-primary">احسب القسط الشهري</button>
                            </div>
                        </div>

                        <hr class="my-4">

                        <div class="row text-center">
                            <div class="col-md-6">
                                <div class="border rounded p-3">
                                    <div class="text-muted">القسط الشهري</div>
                                    <div id="monthlyPayment" class="fs-4 fw-bold">—</div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="border rounded p-3">
                                    <div class="text-muted">إجمالي التكلفة</div>
                                    <div id="totalCost" class="fs-5 fw-bold">—</div>
                                </div>
                            </div>
                        </div>
                        <div class="small text-muted mt-2">النتائج تقديرية وليست عرضًا تمويليًا.</div>
                    </div>
                </div>
            </div>

            <div class="col-lg-5">
                <div class="card shadow-sm">
                    <div class="card-body">
                        <h2 class="h6">إرشادات وسياسات عامة</h2>
                        <ul class="small mb-0">
                            <li>قد تختلف الحدود حسب البنك والمنتج.</li>
                            <li>النسبة السنوية تقريبية إن لم تختر عرضًا محددًا.</li>
                            <li>لنتائج أدق اختر عرض البنك المطلوب.</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>
{% endblock %}

{% block scripts %}
<script>
  (function () {
    function byId(id) { return document.getElementById(id); }
    function formatCurrency(value) {
      if (!isFinite(value)) return '—';
      return new Intl.NumberFormat('ar-EG', { maximumFractionDigits: 2 }).format(value) + ' ر.ع';
    }
    function computeMonthlyPayment(principal, annualRatePercent, tenureMonths) {
      var p = Number(principal);
      var annualRate = Number(annualRatePercent);
      var n = Number(tenureMonths);
      if (!p || !annualRate || !n) return { monthly: NaN, totalInterest: NaN, totalCost: NaN };
      var r = (annualRate / 100) / 12;
      var factor = Math.pow(1 + r, n);
      var monthly = (p * r * factor) / (factor - 1);
      var totalCost = monthly * n;
      var totalInterest = totalCost - p;
      return { monthly: monthly, totalInterest: totalInterest, totalCost: totalCost };
    }

    function updateHints(minMonths, maxMonths, minAmount, maxAmount) {
      var tenureHint = byId('tenureHint');
      var amountHint = byId('amountHint');
      if (tenureHint) {
        var parts = [];
        if (minMonths) parts.push('الأدنى: ' + minMonths + ' شهر');
        if (maxMonths) parts.push('الأقصى: ' + maxMonths + ' شهر');
        tenureHint.textContent = parts.join(' — ');
      }
      if (amountHint) {
        var aparts = [];
        if (minAmount) aparts.push('الأدنى: ' + Number(minAmount).toLocaleString('ar-EG') + ' ر.ع');
        if (maxAmount) aparts.push('الأقصى: ' + Number(maxAmount).toLocaleString('ar-EG') + ' ر.ع');
        amountHint.textContent = aparts.join(' — ');
      }
    }

    function clipByPolicy(value, min, max) {
      var v = Number(value);
      if (isFinite(min) && v < min) v = min;
      if (isFinite(max) && v > max) v = max;
      return v;
    }

    function recalc() {
      var amountEl = byId('loanAmount');
      var monthsEl = byId('tenureMonths');
      var rateEl = byId('interestRate');
      var offer = byId('offerSelect');
      var selected = offer && offer.options[offer.selectedIndex];
      var minMonths = selected && selected.dataset.minMonths ? Number(selected.dataset.minMonths) : NaN;
      var maxMonths = selected && selected.dataset.maxMonths ? Number(selected.dataset.maxMonths) : NaN;
      var minAmount = selected && selected.dataset.minAmount ? Number(selected.dataset.minAmount) : NaN;
      var maxAmount = selected && selected.dataset.maxAmount ? Number(selected.dataset.maxAmount) : NaN;
      updateHints(isFinite(minMonths)?minMonths:null, isFinite(maxMonths)?maxMonths:null, isFinite(minAmount)?minAmount:null, isFinite(maxAmount)?maxAmount:null);

      if (amountEl) amountEl.value = clipByPolicy(amountEl.value, minAmount, maxAmount);
      if (monthsEl) monthsEl.value = clipByPolicy(monthsEl.value, minMonths, maxMonths);

      var result = computeMonthlyPayment(amountEl && amountEl.value, rateEl && rateEl.value, monthsEl && monthsEl.value);
      var monthlyEl = byId('monthlyPayment');
      var totalEl = byId('totalCost');
      if (monthlyEl) monthlyEl.textContent = formatCurrency(result.monthly);
      if (totalEl) totalEl.textContent = formatCurrency(result.totalCost);
    }

    function onOfferChange() {
      var select = byId('offerSelect');
      var selected = select && select.options[select.selectedIndex];
      if (!selected) return;
      var rate = selected.value ? Number(selected.value) : null;
      if (rate != null && !isNaN(rate)) {
        byId('interestRate').value = rate;
      }
      recalc();
    }

    function attachEvents() {
      ['loanAmount', 'tenureMonths', 'interestRate'].forEach(function (id) {
        var el = byId(id);
        if (el) {
          el.addEventListener('input', recalc);
          el.addEventListener('change', recalc);
        }
      });
      var offer = byId('offerSelect');
      if (offer) offer.addEventListener('change', onOfferChange);
      var btn = byId('calcBtn');
      if (btn) btn.addEventListener('click', function (e) { e.preventDefault(); recalc(); });
    }

    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', attachEvents);
    } else {
      attachEvents();
    }
  })();
</script>
{% endblock %}

