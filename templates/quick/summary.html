{% extends 'base.html' %}
{% block title %}تقييم فوري - النتيجة{% endblock %}
{% block content %}
<section class="py-5 bg-light">
  <div class="container">

    <!-- بطاقة النتيجة السريعة -->
    <div class="card shadow-sm mb-4">
      <div class="card-body text-center">
        <h4 class="fw-bold">القيمة التقديرية</h4>
        <div class="display-5 text-primary my-3" id="quickEstimate">{{ "{:,}".format(estimate) }} ر.ع</div>
        <small class="text-muted">هذه نتيجة تقديرية غير ملزمة</small>
      </div>
    </div>

    <!-- حاسبة ديناميكية -->
    <div class="card shadow-sm mb-4">
      <div class="card-body">
        <h5 class="mb-4">حاسبة التثمين التلقائية</h5>

        <div class="row g-3 mb-3">
          <div class="col-md-4">
            <label class="form-label">نوع العقار</label>
            <select id="prop_type" class="form-select">
              <option value="land">أرض</option>
              <option value="house">منزل / فيلا</option>
              <option value="apartment">شقة</option>
            </select>
          </div>
          <div class="col-md-4">
            <label class="form-label">الشركة المعتمدة</label>
            <select id="company_id" class="form-select">
              <option value="">— بدون شركة —</option>
              {% for c in (companies or []) %}
              <option value="{{ c.id }}" {% if selected_company_id and selected_company_id == c.id %}selected{% endif %}>{{ c.name }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="col-md-4">
            <label class="form-label">الولاية</label>
            <select id="wilaya" class="form-select"></select>
          </div>
        </div>

        <div class="row g-3 mb-3">
          <div class="col-md-4">
            <label class="form-label">المنطقة</label>
            <select id="region" class="form-select"></select>
          </div>
          <div class="col-md-4">
            <label class="form-label">استعمال الأرض</label>
            <select id="land_use" class="form-select">
              <option value="سكني" selected>سكني</option>
              <option value="تجاري">تجاري</option>
              <option value="صناعي">صناعي</option>
              <option value="زراعي">زراعي</option>
            </select>
          </div>
          <div class="col-md-4">
            <label class="form-label">مساحة الأرض (م²)</label>
            <input id="land_area" type="number" min="0" class="form-control" placeholder="مثال: 300" value="{{ default_land_area or '' }}">
          </div>
        </div>

        <div class="row g-3 mb-4">
          <div class="col-md-4">
            <label class="form-label">مساحة البناء (م²)</label>
            <input id="build_area" type="number" min="0" class="form-control" placeholder="مثال: 200">
          </div>
          <div class="col-md-4">
            <label class="form-label">عمر البناء (سنة)</label>
            <input id="age" type="number" min="0" class="form-control" placeholder="مثال: 5">
          </div>
        </div>

        <!-- بطاقات النتائج التفصيلية -->
        <div class="row g-3">
          <div class="col-md-3">
            <div class="card text-center shadow-sm">
              <div class="card-body">
                <h6 class="card-title text-muted">قيمة الأرض</h6>
                <div class="h5 text-success" id="land_value">—</div>
              </div>
            </div>
          </div>
          <div class="col-md-3">
            <div class="card text-center shadow-sm">
              <div class="card-body">
                <h6 class="card-title text-muted">قيمة البناء</h6>
                <div class="h5 text-warning" id="build_value">—</div>
              </div>
            </div>
          </div>
          <div class="col-md-3">
            <div class="card text-center shadow-sm">
              <div class="card-body">
                <h6 class="card-title text-muted">معامل الموقع</h6>
                <div class="h5 text-info" id="loc_factor">—</div>
              </div>
            </div>
          </div>
          <div class="col-md-3">
            <div class="card text-center shadow-sm">
              <div class="card-body">
                <h6 class="card-title text-muted">الإجمالي التقديري</h6>
                <div class="h4 text-primary fw-bold" id="total_value">—</div>
              </div>
            </div>
          </div>
        </div>

        <!-- أزرار التنقل -->
        <div class="mt-4 d-flex gap-2">
          <a class="btn btn-primary" href="{{ url_for('main.certified_step_entity') }}">التقييم المعتمد</a>
          <a id="resetBtn" class="btn btn-outline-secondary" href="{{ url_for('main.quick_step_summary', company_id=selected_company_id) }}">إعادة التهيئة</a>
        </div>
      </div>
    </div>
  </div>
</section>

<!-- سكريبت للحساب الديناميكي -->
<script>
(function() {
  // عناصر DOM
  const el = (id) => document.getElementById(id);
  const fmt = (n) => (isFinite(n) ? n.toLocaleString('en-US') : '—');

  let LOCATIONS = [];
  let propType = el('prop_type').value || 'land';
  const wilayaSel = el('wilaya');
  const regionSel = el('region');
  const landUseSel = el('land_use');
  const landAreaInp = el('land_area');
  const buildAreaInp = el('build_area');
  const ageInp = el('age');
  const companySel = el('company_id');

  const landValueEl = el('land_value');
  const buildValueEl = el('build_value');
  const locFactorEl = el('loc_factor');
  const totalValueEl = el('total_value');
  const quickValueEl = el('quickEstimate');

  let currentPricing = null;

  // تحميل الولايات والمناطق
  async function reloadLocations() {
    const companyId = companySel.value || '';
    const params = new URLSearchParams();
    if(companyId) params.append('company_id', companyId);
    try {
      const res = await fetch(`/api/land_locations?${params.toString()}`);
      const data = await res.json();
      LOCATIONS = Array.isArray(data.locations) ? data.locations : [];
      populateWilayas();
      populateRegions();
    } catch (e) {
      LOCATIONS = [];
    }
  }

  function populateWilayas() {
    wilayaSel.innerHTML = '';
    LOCATIONS.forEach(item => {
      const opt = document.createElement('option');
      opt.value = item.wilaya; opt.textContent = item.wilaya;
      wilayaSel.appendChild(opt);
    });
  }

  function populateRegions() {
    const w = wilayaSel.value;
    regionSel.innerHTML = '';
    const entry = LOCATIONS.find(x => x.wilaya === w);
    const regions = entry ? entry.regions : [];
    regions.forEach(r => {
      const opt = document.createElement('option');
      opt.value = r; opt.textContent = r;
      regionSel.appendChild(opt);
    });
  }

  async function updatePricing() {
    const w = wilayaSel.value;
    const r = regionSel.value;
    const companyId = companySel.value || null;
    const landUse = landUseSel.value || null;
    if(!w || !r) return;

    try {
      const params = new URLSearchParams({ wilaya: w, region: r });
      if(companyId) params.append('company_id', companyId);
      if(landUse) params.append('use', landUse);
      const res = await fetch(`/api/company_region_price?${params.toString()}`);
      const data = await res.json();
      currentPricing = data;
      recalc();
    } catch(e) {
      currentPricing = null;
      recalc();
    }
  }

  function recalc() {
    const landArea = Number(landAreaInp.value) || 0;
    const buildArea = Number(buildAreaInp.value) || 0;
    const age = Number(ageInp.value) || 0;

    const landPrice = currentPricing?.landPrice || NaN;
    const buildPrice = currentPricing?.buildPrice || 220;
    const locFactor = currentPricing?.locFactor || 1.0;

    const depreciation = Math.max(0.40, 1 - age * 0.02);

    const landVal = landArea * landPrice;
    const buildVal = propType==='land' ? 0 : buildArea * buildPrice * depreciation;
    const total = (landVal + buildVal) * locFactor;

    landValueEl.textContent = fmt(landVal);
    buildValueEl.textContent = propType==='land' ? '—' : fmt(buildVal);
    locFactorEl.textContent = locFactor.toFixed(2);
    totalValueEl.textContent = fmt(total);
    quickValueEl.textContent = fmt(total) + ' ر.ع';
  }

  // أحداث
  wilayaSel.addEventListener('change', () => { populateRegions(); updatePricing(); });
  regionSel.addEventListener('change', updatePricing);
  landUseSel.addEventListener('change', updatePricing);
  landAreaInp.addEventListener('input', recalc);
  buildAreaInp.addEventListener('input', recalc);
  ageInp.addEventListener('input', recalc);
  companySel.addEventListener('change', async () => { await reloadLocations(); updatePricing(); });

  el('prop_type').addEventListener('change', () => {
    propType = el('prop_type').value;
    if(propType==='land') {
      buildAreaInp.value=''; ageInp.value='';
      buildAreaInp.disabled=true; ageInp.disabled=true;
    } else {
      buildAreaInp.disabled=false; ageInp.disabled=false;
    }
    recalc();
  });

  // Init
  (async () => { await reloadLocations(); updatePricing(); })();
})();
</script>
{% endblock %}
