{% extends 'base.html' %}
{% block title %}الصفحة الرئيسية - منصة التثمين العقاري{% endblock %}
{% block head %}{% endblock %}
{% block content %}
    {% from 'partials/cards.html' import cards_grid %}
    <!-- CTA as cards -->
    <section id="cta" class="py-5">
        <div class="container">
            <div class="text-center mb-4">
                <h1 class="fw-bold mb-3">ابدأ التقييم</h1>
                <p class="text-muted">اختر نوع الخدمة المناسبة لك</p>
            </div>
            {{ cards_grid([
              { 'title': 'تقييم فوري', 'href': url_for('main.quick_page'), 'icon_class': 'bi bi-lightning-charge', 'color_class': 'tile-success', 'subtitle': 'نتيجة تقديرية سريعة' },
              { 'title': 'تقييم معتمد', 'href': url_for('main.certified_page'), 'icon_class': 'bi bi-patch-check', 'color_class': 'tile-primary', 'subtitle': 'طلب تقرير معتمد' },
              { 'title': 'البنوك المشاركة', 'href': url_for('main.banks_list'), 'icon_class': 'bi bi-bank', 'color_class': 'tile-warning', 'subtitle': 'تعرف على البنوك' },
              { 'title': 'شركات التثمين', 'href': url_for('main.companies_list'), 'icon_class': 'bi bi-buildings', 'color_class': 'tile-danger', 'subtitle': 'شاهد الشركات' },
            ]) }}
        </div>
    </section>

    <!-- Quick Valuation Section: now a separate page at /quick -->
    <!-- Removed inline quick form from landing to avoid duplication -->

    <!-- Certified Valuation Section: now a separate page at /certified -->
    <!-- Removed inline certified form from landing to avoid duplication -->

    <!-- News Section -->
    <section id="news" class="bg-light py-5">
        <div class="container">
            <h2 class="text-center mb-5">أحدث الأخبار</h2>
            {% if latest_news and latest_news|length > 0 %}
            <div class="row g-4">
                {% for item in latest_news %}
                <div class="col-md-4" data-aos="fade-up" data-aos-delay="{{ loop.index0 * 100 }}">
                    <div class="card h-100">
                        {% if item.image_path %}
                        <img src="{{ url_for('static', filename=item.image_path) }}" class="card-img-top" alt="خبر" />
                        {% endif %}
                        <div class="card-body d-flex flex-column">
                            <h5 class="card-title">{{ item.title }}</h5>
                            {% if item.body %}
                            <p class="card-text text-muted small text-truncate">{{ item.body }}</p>
                            {% endif %}
                            <div class="mt-auto">
                                <a href="#" class="stretched-link">اقرأ المزيد</a>
                            </div>
                        </div>
                        <div class="card-footer text-muted small">
                            {{ item.created_at.strftime('%Y-%m-%d') if item.created_at else '' }}
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div class="alert alert-info text-center">لا توجد أخبار بعد.</div>
            {% endif %}
        </div>
    </section>

    <!-- Blacklist Search Section -->
    <section id="blacklist" class="py-5">
        <div class="container">
            <h2 class="text-center mb-4">التحقق من القائمة السوداء</h2>
            <div class="row justify-content-center">
                <div class="col-md-8">
                    <form id="blacklist-form" class="row g-2 align-items-center">
                        <div class="col-sm-9">
                            <label for="blacklistQuery" class="form-label">أدخل رقم البطاقة أو رقم الجوال</label>
                            <input type="text" class="form-control" id="blacklistQuery" placeholder="مثال: 1234567890 أو 05xxxxxxxx">
                        </div>
                        <div class="col-sm-3 d-grid">
                            <label class="form-label invisible">&nbsp;</label>
                            <button type="submit" class="btn btn-danger">بحث</button>
                        </div>
                    </form>
                    <div id="blacklist-results" class="mt-4" hidden>
                        <div class="alert alert-info" id="blacklist-empty" hidden>لا توجد نتائج مطابقة.</div>
                        <div class="table-responsive" id="blacklist-table-wrap" hidden>
                            <table class="table table-striped">
                                <thead>
                                    <tr>
                                        <th>رقم البطاقة</th>
                                        <th>رقم الجوال</th>
                                        <th>السبب</th>
                                        <th>تاريخ الإضافة</th>
                                    </tr>
                                </thead>
                                <tbody id="blacklist-tbody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Testimonials Section + Share Your Experience -->
<section id="testimonials" class="py-5 bg-light">
    <div class="container">
        <h2 class="text-center mb-5">تجارب العملاء</h2>
        
        <!-- Existing Testimonials -->
        <div class="row g-4 mb-5">
            <div class="col-md-4 text-center" data-aos="fade-up">
                <blockquote class="blockquote">
                    <p>"خدمة رائعة وسريعة جدًا، أنصح الجميع باستخدام المنصة."</p>
                    <footer class="blockquote-footer">أحمد علي</footer>
                </blockquote>
            </div>
            <div class="col-md-4 text-center" data-aos="fade-up" data-aos-delay="100">
                <blockquote class="blockquote">
                    <p>"تجربة مميزة وفريق محترف، كل شيء كان سلسًا."</p>
                    <footer class="blockquote-footer">سارة حسن</footer>
                </blockquote>
            </div>
            <div class="col-md-4 text-center" data-aos="fade-up" data-aos-delay="200">
                <blockquote class="blockquote">
                    <p>"الحصول على التقرير كان سريع ودقيق، أنصح بهذه الخدمة."</p>
                    <footer class="blockquote-footer">محمد سالم</footer>
                </blockquote>
            </div>
        </div>

        <!-- Share Your Experience Form -->
        <div class="row justify-content-center">
            <div class="col-md-6" data-aos="fade-up" data-aos-delay="300">
                <h3 class="text-center mb-4">شارك تجربتك معنا</h3>
                <form id="testimonial-form">
                    <div class="mb-3">
                        <label for="name" class="form-label">الاسم</label>
                        <input type="text" class="form-control" id="name" placeholder="اسمك">
                    </div>
                    <div class="mb-3">
                        <label for="experience" class="form-label">تجربتك</label>
                        <textarea class="form-control" id="experience" rows="4" placeholder="اكتب تجربتك هنا"></textarea>
                    </div>
                    <button type="submit" class="btn btn-primary w-100">إرسال تجربتك</button>
                </form>
            </div>
        </div>
    </div>
</section>

{% endblock %}

{% block scripts %}
<script>
  (function() {
    const form = document.getElementById('blacklist-form');
    if (!form) return;
    const input = document.getElementById('blacklistQuery');
    const resultsWrap = document.getElementById('blacklist-results');
    const emptyAlert = document.getElementById('blacklist-empty');
    const tableWrap = document.getElementById('blacklist-table-wrap');
    const tbody = document.getElementById('blacklist-tbody');

    async function search(q) {
      const url = new URL('/api/blacklist_search', window.location.origin);
      url.searchParams.set('q', q);
      const res = await fetch(url.toString());
      if (!res.ok) {
        return [];
      }
      return await res.json();
    }

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      const q = (input.value || '').trim();
      if (!q) return;
      resultsWrap.hidden = false;
      emptyAlert.hidden = true;
      tableWrap.hidden = true;
      tbody.innerHTML = '';

      try {
        const data = await search(q);
        if (!data || data.length === 0) {
          emptyAlert.hidden = false;
          tableWrap.hidden = true;
          return;
        }
        data.forEach((row) => {
          const tr = document.createElement('tr');
          const idTd = document.createElement('td');
          idTd.textContent = row.id_number || '—';
          const phoneTd = document.createElement('td');
          phoneTd.textContent = row.phone || '—';
          const reasonTd = document.createElement('td');
          reasonTd.textContent = row.reason || '—';
          const dateTd = document.createElement('td');
          dateTd.textContent = (row.created_at || '').split('T')[0] || '—';
          tr.appendChild(idTd);
          tr.appendChild(phoneTd);
          tr.appendChild(reasonTd);
          tr.appendChild(dateTd);
          tbody.appendChild(tr);
        });
        tableWrap.hidden = false;
      } catch (err) {
        emptyAlert.hidden = false;
        tableWrap.hidden = true;
      }
    });
  })();
</script>
{% endblock %}
