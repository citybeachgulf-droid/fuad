{% extends 'layout.html' %}
{% block content %}

<div class="container py-5" dir="rtl">

  <!-- Header -->
  <div class="text-center mb-5">
    <div class="bg-primary bg-opacity-10 text-primary d-inline-flex align-items-center justify-content-center rounded-circle" style="width:70px; height:70px;">
      <i class="bi bi-file-earmark-text fs-2"></i>
    </div>
    <h3 class="fw-bold mt-3">تفاصيل المعاملة</h3>
    <p class="text-muted mb-0">رقم المعاملة: <strong>#{{ request_obj.id }}</strong></p>
  </div>

  <!-- Main Card -->
  <div class="card shadow-sm border-0 rounded-4 mb-4">
    <div class="card-body">
      <div class="row g-3">
        <div class="col-12 col-md-6">
          <p class="mb-1 text-muted small">العنوان</p>
          <h6>{{ request_obj.title or '-' }}</h6>
        </div>
        <div class="col-12 col-md-6">
          <p class="mb-1 text-muted small">النوع</p>
          <h6>
            {% if request_obj.valuation_type == 'land' %}أرض
            {% elif request_obj.valuation_type == 'property' %}عقار
            {% elif request_obj.valuation_type == 'house' %}بناء منزل
            {% else %}-{% endif %}
          </h6>
        </div>
        <div class="col-12">
          <p class="mb-1 text-muted small">الوصف</p>
          <div class="p-2 bg-light rounded-3">{{ request_obj.description or '-' }}</div>
        </div>
        <div class="col-12 col-md-6">
          <p class="mb-1 text-muted small">الشركة الحالية</p>
          <h6>{{ request_obj.company.name if request_obj.company else '-' }}</h6>
        </div>
        <div class="col-12 col-md-6">
          <p class="mb-1 text-muted small">الحالة</p>
          <span class="badge 
            {% if request_obj.status == 'approved' %}bg-success
            {% elif request_obj.status == 'pending' %}bg-warning text-dark
            {% elif request_obj.status == 'rejected' %}bg-danger
            {% else %}bg-secondary{% endif %}
          ">
            {{ request_obj.status | capitalize }}
          </span>
        </div>

        {% if (request_obj.status or '').lower() == 'revision_requested' %}
        <div class="col-12">
          <div class="alert alert-warning rounded-3">
            <i class="bi bi-exclamation-triangle-fill me-2"></i>
            <strong>مستندات ناقصة مطلوبة.</strong>
            <div class="mt-1">{{ missing_docs_note or 'يرجى تزويد الشركة بالمستندات المطلوبة.' }}</div>
            {% if missing_docs_time %}
            <div class="small text-muted mt-1">آخر تحديث: {{ missing_docs_time }}</div>
            {% endif %}
          </div>
        </div>
        {% endif %}

        {% if request_obj.status == 'rejected' and request_obj.rejection_reason %}
        <div class="col-12">
          <div class="alert alert-danger rounded-3">
            <i class="bi bi-x-circle-fill me-2"></i>
            <strong>تم رفض المعاملة</strong><br>
            <span><strong>السبب:</strong> {{ request_obj.rejection_reason }}</span>
            {% if request_obj.rejected_at %}
            <div class="small text-muted mt-1">تاريخ الرفض: {{ request_obj.rejected_at }}</div>
            {% endif %}
          </div>
        </div>
        {% endif %}

        <div class="col-12 col-md-6">
          <p class="mb-1 text-muted small">القيمة المقدّرة</p>
          <h6>{{ request_obj.value if request_obj.value is not none else '-' }}</h6>
        </div>
        <div class="col-12 col-md-6">
          <p class="mb-1 text-muted small">قيمة التثمين المطلوبة (من البنك)</p>
          <h6>{{ request_obj.requested_amount if request_obj.requested_amount is not none else '-' }}</h6>
        </div>
      </div>
    </div>
  </div>

  <!-- Acceptance CTA: shown if company completed valuation but client not yet accepted -->
  {% if (request_obj.status or '').lower() == 'completed' %}
  <div class="card border-0 shadow-sm rounded-4 mb-4">
    <div class="card-body">
      <h5 class="fw-bold mb-3"><i class="bi bi-check2-circle me-2 text-success"></i> قبول التقييم</h5>
      <form method="POST" action="{{ url_for('client.accept_valuation', request_id=request_obj.id) }}">
        <button type="submit" class="btn btn-success">أوافق على نتيجة التقييم</button>
      </form>
      <p class="text-muted small mt-2">بعد القبول سيتم إخطار الشركة لرفع التقرير النهائي وإرساله لك.</p>
    </div>
  </div>
  {% endif %}

  {% if request_obj.documents %}
  <!-- Documents Section -->
  <div class="card border-0 shadow-sm rounded-4 mb-4">
    <div class="card-body">
      <h5 class="fw-bold mb-3"><i class="bi bi-folder2-open me-2 text-primary"></i> المستندات</h5>
      <ul class="list-group list-group-flush">
        {% for d in request_obj.documents %}
        <li class="list-group-item d-flex justify-content-between align-items-center">
          <div>
            <strong>{{ d.doc_type | doc_label_ar }}</strong>
            {% if d.original_filename %}
              <small class="text-muted ms-1">({{ d.original_filename }})</small>
            {% endif %}
          </div>
          <a href="{{ d.file_path | static_or_external }}" target="_blank" class="btn btn-sm btn-outline-primary">
            <i class="bi bi-eye"></i> عرض
          </a>
        </li>
        {% endfor %}
      </ul>
    </div>
  </div>
  {% endif %}

  <!-- Transfer Section -->
  <div class="card border-0 shadow-sm rounded-4 mb-4">
    <div class="card-body">
      <h5 class="fw-bold mb-3"><i class="bi bi-building-gear me-2 text-warning"></i> تحويل المعاملة إلى شركة أخرى</h5>
      <form method="POST" action="{{ url_for('client.transfer_request', request_id=request_obj.id) }}" class="row g-2">
        <div class="col-md-6">
          <select class="form-select rounded-3" name="company_id" required>
            <option value="">— اختر الشركة —</option>
            {% for c in companies %}
              <option value="{{ c.id }}" {% if request_obj.company and c.id == request_obj.company.id %}disabled{% endif %}>{{ c.name }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="col-md-6 d-grid d-md-flex justify-content-md-end">
          <button type="submit" class="btn btn-warning text-dark rounded-3 px-4">
            <i class="bi bi-arrow-left-right me-1"></i> تحويل المعاملة
          </button>
        </div>
      </form>
      <p class="text-muted small mt-2">سيتم إعادة حالة المعاملة إلى <strong>قيد المراجعة</strong> وإلغاء المواعيد السابقة.</p>
    </div>
  </div>

  <!-- Back Button -->
  <div class="text-center">
    <a class="btn btn-secondary rounded-3 px-4" href="{{ url_for('client.dashboard') }}">
      <i class="bi bi-arrow-right-circle me-1"></i> عودة إلى لوحة العميل
    </a>
  </div>

</div>

{% endblock %}
