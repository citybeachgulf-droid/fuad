{% extends 'layout.html' %}
{% block content %}

<div class="container py-5" dir="rtl">

  <h3 class="mb-4 text-center fw-bold">رفع المستندات - طلب رقم {{ request_obj.id }}</h3>

  <!-- Progress -->
  <div class="mb-4">
    <div class="progress rounded-pill" style="height: 10px;">
      <div class="progress-bar bg-success" role="progressbar" style="width: 100%"></div>
    </div>
    <div class="text-end mt-1">
      <small class="text-muted">الخطوة 2/2: رفع المستندات</small>
    </div>
  </div>

  <form method="POST" enctype="multipart/form-data" id="docsForm">

    <!-- Requested Amount -->
    <div class="card shadow-sm rounded-4 mb-4 p-3">
      <label class="form-label fw-semibold">قيمة التثمين المطلوبة من البنك (اختياري)</label>
      <div class="input-group">
        <span class="input-group-text">ر.ع</span>
        <input type="number" step="0.01" min="0" class="form-control" name="requested_amount" placeholder="مثال: 50000" value="{{ request_obj.requested_amount or '' }}">
      </div>
      <div class="form-text">اكتب المبلغ الذي طلبه البنك لتثمين العقار.</div>
    </div>

    <!-- Required Documents -->
    <div class="row g-3">
      {% for key, label, icon in required_docs %}
      <div class="col-12 col-md-6">
        <div class="card shadow-sm rounded-4 h-100">
          <div class="card-body">
            <h5 class="card-title mb-3"><i class="bi {{ icon }} me-2 text-primary"></i>{{ label }}</h5>
            <input class="form-control" type="file" name="{{ key }}[]" multiple accept="image/*,application/pdf" required>
            <div class="form-text">المسموح: صور أو PDF. الحد الأقصى {{ (max_bytes // (1024*1024)) }}MB.</div>
          </div>
        </div>
      </div>
      {% endfor %}
    </div>

    <!-- Buttons -->
    <div class="mt-4 d-flex justify-content-end gap-2">
      <a href="{{ url_for('client.dashboard') }}" class="btn btn-secondary rounded-3 px-4">إلغاء</a>
      <button class="btn btn-success rounded-3 px-4" type="submit">إرسال</button>
    </div>

  </form>

</div>

{% endblock %}

{% block scripts %}
{{ super() }}
<script>
(function(){
  const form = document.getElementById('docsForm');
  const MAX = {{ max_bytes | int }};

  form.addEventListener('submit', function(e){
    const inputs = form.querySelectorAll('input[type="file"]');
    for (const input of inputs) {
      if (!input.files || input.files.length === 0) {
        alert('يرجى اختيار الملفات المطلوبة');
        e.preventDefault();
        return false;
      }
      for (const f of input.files) {
        if (f.size > MAX) {
          alert('حجم ملف كبير جدًا. الحد الأقصى ' + (MAX/1024/1024).toFixed(1) + 'MB');
          e.preventDefault();
          return false;
        }
        const ok = f.type.startsWith('image/') || f.type === 'application/pdf';
        if (!ok) {
          alert('نوع ملف غير مدعوم. المسموح صور أو PDF');
          e.preventDefault();
          return false;
        }
      }
    }
  });
})();
</script>
{% endblock %}
