{% extends 'layout.html' %}
{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
  <h2>لوحة العميل</h2>
  <div class="d-flex gap-2">
    <a class="btn btn-success" href="{{ url_for('client.submit_request') }}">طلب تثمين جديد</a>
  </div>

</div>

<table class="table mt-3">
  <thead>
    <tr>
      <th>#</th>
      <th>العنوان</th>
      <th>نوع التثمين</th>
      <th>الشركة</th>
      <th>الحالة</th>
      <th>إجراء</th>
    </tr>
  </thead>
  <tbody>
    {% for r in requests %}
      <tr>
        <td><a href="{{ url_for('client.request_detail', request_id=r.id) }}">{{ r.id }}</a></td>
        <td>
          <a href="{{ url_for('client.request_detail', request_id=r.id) }}">{{ r.title }}</a>
          {% if (r.status or '').lower() == 'revision_requested' %}
            <div class="small mt-1">
              <span class="badge text-bg-warning"><i class="bi bi-exclamation-triangle me-1"></i>مستندات ناقصة</span>
              {% if r.revision_notes %}
                <span class="text-muted">— {{ r.revision_notes[:80] }}{% if r.revision_notes|length > 80 %}...{% endif %}</span>
              {% endif %}
            </div>
          {% endif %}
        </td>
        <td>
          {% if r.valuation_type == 'land' %}أرض{% elif r.valuation_type == 'property' %}عقار{% elif r.valuation_type == 'house' %}بناء منزل{% else %}-{% endif %}
        </td>
        <td>{{ r.company.name if r.company else '-' }}</td>
        <td>{{ r.status }}</td>
        <td class="d-flex gap-2">
          <a class="btn btn-sm btn-outline-secondary" href="{{ url_for('client.request_detail', request_id=r.id) }}">تفاصيل</a>
          {% set has_final = r.appointments|selectattr('status', 'equalto', 'final')|list|length > 0 %}
          {% if (r.status or '').lower() == 'completed' and not has_final %}
            <a class="btn btn-sm btn-primary" href="{{ url_for('client.propose_appointment', request_id=r.id) }}">تحديد موعد زيارة</a>
          {% endif %}
        </td>
      </tr>
    {% endfor %}
  </tbody>
</table>
{% endblock %}
