{% extends 'layout.html' %}
{% block content %}
<h2>تفاصيل المعاملة #{{ request_obj.id }}</h2>

<div class="card mb-3">
  <div class="card-body">
    <p><strong>العنوان:</strong> {{ request_obj.title or '-' }}</p>
    <p><strong>الوصف:</strong> {{ request_obj.description or '-' }}</p>
    <p><strong>النوع:</strong>
      {% if request_obj.valuation_type == 'land' %}أرض{% elif request_obj.valuation_type == 'property' %}عقار{% elif request_obj.valuation_type == 'house' %}بناء منزل{% else %}-{% endif %}
    </p>
    <p><strong>العميل:</strong> {{ request_obj.client.name if request_obj.client else '-' }}</p>
    <p><strong>الحالة:</strong> {{ request_obj.status }}</p>
    {% if request_obj.status == 'rejected' and request_obj.rejection_reason %}
      <div class="alert alert-danger mt-2">
        <div><strong>سبب الرفض:</strong></div>
        <div>{{ request_obj.rejection_reason }}</div>
        {% if request_obj.rejected_at %}
          <div class="small text-muted mt-1">تاريخ الرفض: {{ request_obj.rejected_at }}</div>
        {% endif %}
      </div>
    {% endif %}
    <p><strong>القيمة المقدّرة:</strong> {{ request_obj.value if request_obj.value is not none else '-' }}</p>
    <p><strong>قيمة التثمين المطلوبة (من البنك):</strong> {{ request_obj.requested_amount if request_obj.requested_amount is not none else '-' }}</p>
  </div>
</div>

{% if request_obj.documents %}
<h4>المستندات</h4>
<ul>
  {% for d in request_obj.documents %}
  <li>
    <strong>{{ d.doc_type | doc_label_ar }}</strong> -
    <a href="{{ d.file_path | static_or_external }}" target="_blank">عرض</a>
    {% if d.original_filename %}<small class="text-muted">({{ d.original_filename }})</small>{% endif %}
  </li>
  {% endfor %}
</ul>
{% endif %}

<div class="mt-3">
  <a class="btn btn-secondary" href="{{ url_for('company.dashboard') }}">عودة إلى لوحة التحكم</a>
  <a class="btn btn-primary" href="{{ url_for('company.submit_valuation', request_id=request_obj.id) }}">إرسال القيمة</a>
  {% if request_obj.status != 'rejected' %}
  <button type="button" class="btn btn-outline-danger" data-bs-toggle="modal" data-bs-target="#rejectModal">رفض المعاملة</button>
  {% endif %}
  {% if request_obj.status == 'rejected' and request_obj.company_id == current_user.id %}
  <form method="post" action="{{ url_for('company.remove_request', request_id=request_obj.id) }}" class="d-inline" onsubmit="return confirm('حذف هذه المعاملة من حساب الشركة؟');">
    <button type="submit" class="btn btn-outline-danger">حذف من حساب الشركة</button>
  </form>
  {% endif %}
</div>
<hr>
<div id="missing-docs" class="mt-3">
  <h5>طلب مستندات ناقصة</h5>
  <form method="post" action="{{ url_for('company.mark_missing_documents', request_id=request_obj.id) }}" class="row g-2">
    <div class="col-12 col-md-8">
      <input type="text" name="notes" class="form-control" placeholder="اكتب الملاحظات للعميل (المستندات المطلوبة)" required>
    </div>
    <div class="col-12 col-md-4">
      <button type="submit" class="btn btn-outline-warning w-100">مستندات ناقصة — إرسال ملاحظات</button>
    </div>
  </form>
  {% if request_obj.status == 'revision_requested' %}
    <div class="form-text mt-2 text-warning">تم طلب مستندات إضافية لهذا الطلب.</div>
  {% endif %}
  <small class="text-muted d-block">سيتم إرسال الملاحظات للعميل عبر نظام المحادثات وتحديث حالة الطلب.</small>
  <small class="text-muted d-block">رقم الطلب: #{{ request_obj.id }}</small>
  
</div>
<!-- Reject Modal -->
<div class="modal fade" id="rejectModal" tabindex="-1" aria-labelledby="rejectModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <form method="post" action="{{ url_for('company.reject_request', request_id=request_obj.id) }}">
        <div class="modal-header">
          <h5 class="modal-title" id="rejectModalLabel">رفض المعاملة #{{ request_obj.id }}</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label">سبب الرفض</label>
            <textarea name="reason" class="form-control" rows="3" placeholder="اكتب سبب الرفض ليظهر للعميل والإدارة" required></textarea>
          </div>
          {% if request_obj.rejection_reason %}
            <div class="alert alert-secondary small">آخر سبب محفوظ: {{ request_obj.rejection_reason }}</div>
          {% endif %}
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إلغاء</button>
          <button type="submit" class="btn btn-danger">تأكيد الرفض</button>
        </div>
      </form>
    </div>
  </div>
</div>
{% endblock %}
