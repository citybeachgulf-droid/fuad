{% extends 'layout.html' %}
{% block content %}
<h2>Bank Dashboard</h2>
<div class="d-flex align-items-center gap-3 mb-3">
  {% if bank_profile and bank_profile.logo_path %}
    <img src="{{ bank_profile.logo_path | static_or_external }}" alt="Logo" class="size-56 img-cover rounded-8 border bg-white p-1">
  {% endif %}
  <form method="post" action="{{ url_for('bank.update_logo') }}" enctype="multipart/form-data" class="d-flex align-items-center gap-2">
    <input type="file" name="logo" accept="image/*" class="form-control form-control-sm" required>
    <button class="btn btn-sm btn-outline-primary">تحديث الشعار</button>
  </form>
  {% if bank_profile and bank_profile.logo_path %}
    <a href="{{ url_for('bank.dashboard') }}" class="btn btn-sm btn-outline-secondary">تحديث العرض</a>
  {% endif %}
  <span class="text-muted">ارفع شعار البنك ليظهر للعملاء.</span>
  <div class="ms-auto"></div>
  {% if bank_profile and bank_profile.slug %}
    <a class="btn btn-sm btn-link" href="{{ url_for('main.bank_detail', slug=bank_profile.slug) }}" target="_blank">عرض صفحة البنك</a>
  {% endif %}
  
</div>
<p>Valuations awaiting review:</p>
<table class="table">
<thead><tr><th>ID</th><th>Title</th><th>Type</th><th>Company</th><th>Value</th><th>Status</th><th>Actions</th></tr></thead>
  <tbody>
    {% for r in requests %}
      <tr>
        <td>{{ r.id }}</td>
        <td>{{ r.title }}</td>
        <td>{% if r.valuation_type == 'land' %}أرض{% elif r.valuation_type == 'property' %}عقار{% elif r.valuation_type == 'house' %}بناء منزل{% else %}-{% endif %}</td>
        <td>{{ r.company.name if r.company else '-' }}</td>
        <td>{{ r.value or '-' }}</td>
        <td>{{ r.status }}</td>
        <td>
          <form method="post" action="{{ url_for('bank.review', request_id=r.id) }}" class="d-flex gap-2">
            <button name="action" value="approve" class="btn btn-sm btn-success">Approve</button>
            <button name="action" value="revision" class="btn btn-sm btn-warning">Request Revision</button>
          </form>
        </td>
      </tr>
    {% endfor %}
  </tbody>
</table>

<hr>

<div class="row g-4">
  <div class="col-md-7">
    <div class="card">
      <div class="card-header">
        <strong>العروض التمويلية الحالية</strong>
      </div>
      <div class="card-body p-0">
        <table class="table mb-0">
          <thead class="table-light">
            <tr>
              <th>المنتج</th>
              <th>نوع السعر</th>
              <th>% الفائدة السنوية</th>
              <th>APR</th>
              <th>الحد الأدنى/الأعلى</th>
              <th>المدة (أشهر)</th>
              <th>ملاحظات</th>
            </tr>
          </thead>
          <tbody>
            {% if offers and offers|length > 0 %}
              {% for o in offers %}
              <tr>
                <td>{{ o.product_name }}</td>
                <td>{{ o.rate_type or '-' }}</td>
                <td>{{ '%.2f' % o.interest_rate }}</td>
                <td>{{ (('%.2f' % o.apr) if o.apr is not none else '-') }}</td>
                <td>
                  {{ (('%.0f' % o.min_amount) if o.min_amount is not none else '-') }} /
                  {{ (('%.0f' % o.max_amount) if o.max_amount is not none else '-') }}
                </td>
                <td>
                  {{ (o.min_tenure_months or '-') }} /
                  {{ (o.max_tenure_months or '-') }}
                </td>
                <td>{{ o.notes or '-' }}</td>
              </tr>
              {% endfor %}
            {% else %}
              <tr>
                <td colspan="7" class="text-center py-3">لا توجد عروض بعد</td>
              </tr>
            {% endif %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
  <div class="col-md-5">
    <div class="card">
      <div class="card-header"><strong>إضافة عرض تمويلي</strong></div>
      <div class="card-body">
        <form method="post" action="{{ url_for('bank.add_offer') }}">
          <div class="mb-3">
            <label class="form-label">اسم المنتج</label>
            <input type="text" name="product_name" class="form-control" placeholder="مثال: قرض سكني" required>
          </div>
          <div class="row g-3">
            <div class="col-6">
              <label class="form-label">نوع السعر</label>
              <select class="form-select" name="rate_type">
                <option value="">—</option>
                <option value="ثابت">ثابت</option>
                <option value="متغير">متغير</option>
              </select>
            </div>
            <div class="col-6">
              <label class="form-label">% الفائدة السنوية</label>
              <input type="number" step="0.01" min="0" name="interest_rate" class="form-control" placeholder="مثال: 6" required>
            </div>
          </div>
          <div class="row g-3 mt-0">
            <div class="col-6">
              <label class="form-label">APR</label>
              <input type="number" step="0.01" min="0" name="apr" class="form-control" placeholder="اختياري">
            </div>
            <div class="col-6">
              <label class="form-label">الحد الأدنى للمبلغ</label>
              <input type="number" step="0.01" min="0" name="min_amount" class="form-control" placeholder="اختياري">
            </div>
          </div>
          <div class="row g-3 mt-0">
            <div class="col-6">
              <label class="form-label">الحد الأقصى للمبلغ</label>
              <input type="number" step="0.01" min="0" name="max_amount" class="form-control" placeholder="اختياري">
            </div>
            <div class="col-6">
              <label class="form-label">المدة الدنيا (أشهر)</label>
              <input type="number" min="0" name="min_tenure_months" class="form-control" placeholder="اختياري">
            </div>
          </div>
          <div class="row g-3 mt-0">
            <div class="col-6">
              <label class="form-label">المدة القصوى (أشهر)</label>
              <input type="number" min="0" name="max_tenure_months" class="form-control" placeholder="اختياري">
            </div>
            <div class="col-6">
              <label class="form-label">ملاحظات</label>
              <input type="text" name="notes" class="form-control" placeholder="اختياري">
            </div>
          </div>
          <div class="mt-3 d-flex justify-content-end">
            <button class="btn btn-primary" type="submit">حفظ العرض</button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<hr>

<!-- إدارة الشركات المعتمدة لدى البنك -->
<div class="row g-4 mt-1">
  <div class="col-md-7">
    <div class="card">
      <div class="card-header"><strong>الشركات المعتمدة</strong></div>
      <div class="card-body p-0">
        <table class="table mb-0 align-middle">
          <thead class="table-light">
            <tr>
              <th>الشركة</th>
              <th>الحد المعتمد</th>
              <th class="text-end">إجراءات</th>
            </tr>
          </thead>
          <tbody>
            {% if approved_companies and approved_companies|length > 0 %}
              {% for c in approved_companies %}
              <tr>
                <td class="fw-semibold">{{ c.name }}</td>
                <td style="width: 240px;">
                  <form class="d-flex gap-2" method="post" action="{{ url_for('bank.update_approved_company', cab_id=c.cab_id) }}">
                    <input type="number" step="0.01" name="limit_value" class="form-control" value="{{ c.limit_value or '' }}" placeholder="اختياري">
                    <button class="btn btn-sm btn-outline-primary">تحديث</button>
                  </form>
                </td>
                <td class="text-end">
                  <form method="post" action="{{ url_for('bank.delete_approved_company', cab_id=c.cab_id) }}" onsubmit="return confirm('تأكيد حذف الاعتماد؟');">
                    <button class="btn btn-sm btn-outline-danger">إزالة</button>
                  </form>
                </td>
              </tr>
              {% endfor %}
            {% else %}
              <tr>
                <td colspan="3" class="text-center py-3 text-muted">لا توجد شركات معتمدة بعد</td>
              </tr>
            {% endif %}
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <div class="col-md-5">
    <div class="card">
      <div class="card-header"><strong>اعتماد شركة جديدة</strong></div>
      <div class="card-body">
        <form method="post" action="{{ url_for('bank.add_approved_company') }}" class="row g-3 align-items-end">
          <div class="col-12">
            <label class="form-label">اختر الشركة</label>
            <select name="company_user_id" class="form-select" required>
              <option value="">— اختر —</option>
              {% for item in companies_to_add or [] %}
                <option value="{{ item.user_id }}">{{ item.name }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="col-12">
            <label class="form-label">الحد المعتمد (اختياري)</label>
            <input type="number" step="0.01" name="limit_value" class="form-control" placeholder="مثال: 100000">
          </div>
          <div class="col-12 d-flex justify-content-end">
            <button class="btn btn-primary">اعتماد</button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<hr>

<div class="card mt-3">
  <div class="card-header"><strong>حاسبة القروض</strong></div>
  <div class="card-body">
    <div class="alert alert-info">قم بتحديد نسب التحمل والسياسات الافتراضية من الأسفل ليتم استخدامها في بوابة العملاء.</div>
    <div class="row g-3">
      <div class="col-md-4">
        <label class="form-label">اختر عرضًا (اختياري)</label>
        <select id="calc_offer" class="form-select">
          <option value="">—</option>
          {% for o in offers or [] %}
            <option value="{{ o.id }}" data-rate="{{ o.interest_rate }}" data-minm="{{ o.min_tenure_months or '' }}" data-maxm="{{ o.max_tenure_months or '' }}">{{ o.product_name }} — {{ '%.2f' % o.interest_rate }}%</option>
          {% endfor %}
        </select>
      </div>
      <div class="col-md-4">
        <label class="form-label">المبلغ (Principal)</label>
        <input id="calc_amount" type="number" min="0" step="0.01" class="form-control" placeholder="مثال: 100000">
      </div>
      <div class="col-md-2">
        <label class="form-label">المدة (شهر)</label>
        <input id="calc_months" type="number" min="1" step="1" class="form-control" placeholder="مثال: 60">
      </div>
      <div class="col-md-2">
        <label class="form-label">% الفائدة السنوية</label>
        <input id="calc_rate" type="number" min="0" step="0.01" class="form-control" placeholder="مثال: 6">
      </div>
    </div>

    <div class="row g-3 mt-3">
      <div class="col-md-3">
        <div class="border rounded p-3 text-center">
          <div class="text-muted">القسط الشهري</div>
          <div id="calc_monthly" class="fs-5 fw-bold">—</div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="border rounded p-3 text-center">
          <div class="text-muted">إجمالي المدفوعات</div>
          <div id="calc_total" class="fs-5 fw-bold">—</div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="border rounded p-3 text-center">
          <div class="text-muted">إجمالي الفائدة</div>
          <div id="calc_interest" class="fs-5 fw-bold">—</div>
        </div>
      </div>
    </div>

    <script>
      (function() {
        const offerSelect = document.getElementById('calc_offer');
        const amountInput = document.getElementById('calc_amount');
        const monthsInput = document.getElementById('calc_months');
        const rateInput = document.getElementById('calc_rate');
        const monthlyEl = document.getElementById('calc_monthly');
        const totalEl = document.getElementById('calc_total');
        const interestEl = document.getElementById('calc_interest');

        function formatCurrency(value) {
          if (!isFinite(value)) return '—';
          try {
            return new Intl.NumberFormat('ar-SA', { style: 'currency', currency: 'SAR' }).format(value);
          } catch (e) {
            return value.toFixed(2);
          }
        }

        function compute() {
          const P = parseFloat(amountInput.value);
          const n = parseInt(monthsInput.value, 10);
          const annual = parseFloat(rateInput.value);
          if (!(P > 0) || !(n > 0) || !(annual >= 0)) {
            monthlyEl.textContent = '—';
            totalEl.textContent = '—';
            interestEl.textContent = '—';
            return;
          }
          const r = (annual / 100) / 12; // معدل شهري
          let M;
          if (r === 0) {
            M = P / n;
          } else {
            M = P * r / (1 - Math.pow(1 + r, -n));
          }
          const total = M * n;
          const interest = total - P;
          monthlyEl.textContent = formatCurrency(M);
          totalEl.textContent = formatCurrency(total);
          interestEl.textContent = formatCurrency(interest);
        }

        offerSelect && offerSelect.addEventListener('change', function() {
          const opt = offerSelect.selectedOptions[0];
          if (!opt) return;
          const rate = opt.getAttribute('data-rate');
          const minm = opt.getAttribute('data-minm');
          const maxm = opt.getAttribute('data-maxm');
          if (rate) rateInput.value = rate;
          if (minm && !monthsInput.value) monthsInput.value = minm;
          if (maxm && monthsInput.value && parseInt(monthsInput.value, 10) > parseInt(maxm, 10)) {
            monthsInput.value = maxm;
          }
          compute();
        });

        [amountInput, monthsInput, rateInput].forEach(function(el) {
          el && el.addEventListener('input', compute);
          el && el.addEventListener('change', compute);
        });
      })();
    </script>
  </div>
</div>

<div class="card mt-3">
  <div class="card-header"><strong>سياسات القروض (للاستخدام في بوابة العملاء)</strong></div>
  <div class="card-body">
    <form method="post" action="{{ url_for('bank.upsert_policy') }}" class="row g-3 align-items-end">
      <div class="col-12 col-md-3">
        <label class="form-label">نوع القرض</label>
        <select name="loan_type" class="form-select">
          <option value="housing">سكني</option>
          <option value="personal">شخصي</option>
          <option value="auto">سيارات</option>
        </select>
      </div>
      <div class="col-12 col-md-3">
        <label class="form-label">نسبة التحمل القصوى</label>
        <select name="max_ratio" class="form-select" required>
          <option value="0.3">30%</option>
          <option value="0.4">40%</option>
          <option value="0.5">50%</option>
        </select>
      </div>
      <div class="col-6 col-md-3">
        <label class="form-label">الفائدة الافتراضية %</label>
        <input type="number" step="0.01" min="0" name="default_annual_rate" class="form-control" placeholder="مثال: 6">
      </div>
      <div class="col-6 col-md-3">
        <label class="form-label">المدة الافتراضية (سنوات)</label>
        <input type="number" min="1" step="1" name="default_years" class="form-control" placeholder="مثال: 20">
      </div>
      <div class="col-12 d-flex justify-content-end">
        <button class="btn btn-primary">حفظ السياسة</button>
      </div>
    </form>

    <hr>
    <div class="table-responsive">
      <table class="table table-sm align-middle">
        <thead class="table-light">
          <tr>
            <th>النوع</th>
            <th>نسبة التحمل</th>
            <th>فائدة افتراضية</th>
            <th>مدة افتراضية (سنوات)</th>
          </tr>
        </thead>
        <tbody>
          {% for p in policies or [] %}
          <tr>
            <td>{{ p.loan_type }}</td>
            <td>{{ (p.max_ratio * 100) | round(0) }}%</td>
            <td>{{ (('%.2f' % p.default_annual_rate) if p.default_annual_rate is not none else '-') }}</td>
            <td>{{ p.default_years or '-' }}</td>
          </tr>
          {% else %}
          <tr>
            <td colspan="4" class="text-center text-muted">لا توجد سياسات بعد</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>
{% endblock %}
