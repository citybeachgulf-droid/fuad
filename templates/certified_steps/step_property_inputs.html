{% extends 'base.html' %}
{% block title %}تقييم معتمد - إدخال بيانات العقار{% endblock %}

{% block head %}
<style>
:root {
  --white: #ffffff;
  --blue-dark-gray: #374568;
  --blue-mid: #425172;
  --navy-dark: #354366;
  --navy-darker: #324063;
  --gray-navy: #344265;
  --gray-blue: #364467;
  --cool-blue: #3e4d6e;
  --primary-gradient: linear-gradient(135deg, #3e4d6e, #425172);
  --btn-hover-gradient: linear-gradient(135deg, #425172, #3e4d6e);
}

/* ====== Reset ====== */
* { margin:0; padding:0; box-sizing:border-box; }
body {
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  background: linear-gradient(160deg, var(--white), var(--blue-mid));
  color: var(--blue-dark-gray);
}

/* ====== Container ====== */
.container { max-width: 1100px; margin: 0 auto; padding: 20px; }

/* ====== Header ====== */
.page-header {
  display: flex; flex-wrap: wrap; align-items: center; justify-content: space-between; margin-bottom: 25px;
}

.page-header h1 { font-size: 1.8rem; color: var(--navy-darker); }
.page-header a.back-btn {
  text-decoration: none; color: var(--cool-blue); font-weight: bold;
  transition: color 0.3s ease;
}
.page-header a.back-btn:hover { color: var(--navy-darker); }

/* ====== Form Card ====== */
.card {
  background: var(--white);
  border-radius: 20px;
  padding: 30px;
  box-shadow: 0 15px 30px rgba(0,0,0,0.1);
  transition: transform 0.3s ease, box-shadow 0.3s ease;
}
.card:hover { transform: translateY(-5px); box-shadow: 0 20px 40px rgba(0,0,0,0.15); }

/* ====== Inputs ====== */
.form-label { font-weight: 600; color: var(--navy-darker); margin-bottom: 5px; }
.form-control {
  width: 100%; padding: 10px 15px; border-radius: 10px; border: 2px solid var(--gray-navy);
  transition: all 0.3s ease; font-size: 0.95rem;
}
.form-control:focus {
  outline: none; border-color: var(--cool-blue); box-shadow: 0 0 8px rgba(62,77,110,0.4);
}

/* ====== Buttons ====== */
button, a.btn {
  border-radius: 50px;
  font-weight: 600;
  padding: 10px 20px;
  transition: all 0.3s ease;
  cursor: pointer;
  display: inline-flex;
  align-items: center; gap: 5px;
  font-size: 0.95rem;
}
#continueBtn {
  background: var(--primary-gradient); color: var(--white); border: none;
}
#continueBtn:hover {
  background: var(--btn-hover-gradient);
  transform: translateY(-2px);
  box-shadow: 0 8px 25px rgba(0,0,0,0.25);
}
#skipBtn {
  background: transparent; color: var(--cool-blue); border: 2px solid var(--cool-blue);
}
#skipBtn:hover { background: var(--cool-blue); color: var(--white); }

/* ====== Responsive ====== */
@media (max-width: 768px) {
  .page-header { flex-direction: column; align-items: flex-start; gap: 10px; }
  .row.g-3.align-items-end { flex-direction: column; }
}
</style>
{% endblock %}

{% block content %}
<section class="py-4">
  <div class="container">
    <div class="page-header">
      <h1>{{ purpose }}</h1>
      <a href="{{ url_for('main.certified_step_purpose', entity=entity) }}" class="back-btn">رجوع</a>
    </div>

    <form class="card">
      <div class="row g-3">
        <div class="col-md-4">
          <label class="form-label">البنك</label>
          <input list="banksList" id="bankInput" class="form-control" placeholder="ابحث واكتب اسم البنك">
          <datalist id="banksList"></datalist>
        </div>
        <div class="col-md-4">
          <label class="form-label">الاستعمال</label>
          <input list="useList" id="useInput" class="form-control" placeholder="سكني، تجاري، صناعي، زراعي">
          <datalist id="useList">
            <option value="سكني"></option>
            <option value="تجاري"></option>
            <option value="صناعي"></option>
            <option value="زراعي"></option>
          </datalist>
        </div>
        <div class="col-md-4">
          <label class="form-label">الولاية</label>
          <input list="wilayasList" id="wilayaInput" class="form-control" placeholder="اكتب لاختيار الولاية">
          <datalist id="wilayasList"></datalist>
        </div>
      </div>

      <div class="row g-3 mt-3">
        <div class="col-md-4">
          <label class="form-label">الحي/القرية</label>
          <input list="regionsList" id="regionInput" class="form-control" placeholder="اكتب لاختيار الحي/القرية">
          <datalist id="regionsList"></datalist>
        </div>
        <div class="col-md-4">
          <label class="form-label">مساحة الأرض (م²)</label>
          <input id="landArea" type="number" min="0" class="form-control" placeholder="مثال: 300">
        </div>
        {% if purpose != 'تثمين أرض' %}
        <div class="col-md-4">
          <label class="form-label">مساحة البناء (م²)</label>
          <input id="buildArea" type="number" min="0" class="form-control" placeholder="مثال: 200">
        </div>
        {% endif %}
      </div>

      <div class="row g-3 mt-3">
        {% if purpose == 'تثمين عقار قائم' %}
        <div class="col-md-4">
          <label class="form-label">عمر المبنى (بالسنوات)</label>
          <input id="buildAge" list="ageList" class="form-control" placeholder="مثال: 10">
          <datalist id="ageList">
            <option value="1"></option>
            <option value="2"></option>
            <option value="3"></option>
            <option value="5"></option>
            <option value="10"></option>
            <option value="15"></option>
            <option value="20"></option>
            <option value="25"></option>
            <option value="30"></option>
            <option value="35"></option>
            <option value="40"></option>
            <option value="50"></option>
          </datalist>
        </div>
        {% endif %}
        <div class="col-md-4">
          <label class="form-label">رقم الهاتف</label>
          <input id="phoneInput" type="tel" inputmode="tel" class="form-control" dir="ltr" placeholder="مثال: 9xxxxxxx أو +9689xxxxxxx">
        </div>
      </div>

      <div class="d-flex gap-2 mt-4">
        <button type="button" id="continueBtn"><i class="bi bi-arrow-left-circle me-1"></i>احصل على عرض التثمين</button>
        <a id="skipBtn" href="{{ url_for('main.certified_step_bank', entity=entity, purpose=purpose) }}">تخطي</a>
      </div>
    </form>
  </div>
</section>
{% endblock %}

{% block scripts %}
<script>
(function() {
  const entity = {{ entity|tojson }};
  const purpose = {{ purpose|tojson }};

  const bankInput = document.getElementById('bankInput');
  const banksList = document.getElementById('banksList');
  const useInput = document.getElementById('useInput');
  const wilayaInput = document.getElementById('wilayaInput');
  const wilayasList = document.getElementById('wilayasList');
  const regionInput = document.getElementById('regionInput');
  const regionsList = document.getElementById('regionsList');
  const landAreaInput = document.getElementById('landArea');
  const buildAreaInput = document.getElementById('buildArea');
  const buildAgeInput = document.getElementById('buildAge');
  const phoneInput = document.getElementById('phoneInput');
  const continueBtn = document.getElementById('continueBtn');

  // Maps for banks and locations
  const bankSlugByName = new Map(); // lower(name) -> slug
  const bankNameBySlug = new Map(); // slug -> name
  const wilayaToRegions = new Map(); // wilaya -> [regions]

  function populateBanks(banks) {
    if (!banksList) return;
    banksList.innerHTML = '';
    bankSlugByName.clear();
    bankNameBySlug.clear();
    (banks || []).forEach(b => {
      const slug = (b && b.slug) ? String(b.slug) : '';
      const name = (b && (b.name || b.slug)) ? String(b.name || b.slug) : slug;
      if (!slug) return;
      bankSlugByName.set(name.toLowerCase(), slug);
      bankNameBySlug.set(slug, name);
      const opt = document.createElement('option');
      opt.value = slug; // ensure input value becomes slug
      opt.label = name; // hint for suggestion UI
      opt.textContent = name;
      banksList.appendChild(opt);
    });
  }

  async function fetchBanks() {
    try {
      const res = await fetch('/api/banks');
      if (!res.ok) return;
      const data = await res.json();
      populateBanks(data);
    } catch (_) { /* ignore */ }
  }

  function populateWilayas(locations) {
    if (!wilayasList) return;
    wilayasList.innerHTML = '';
    regionsList && (regionsList.innerHTML = '');
    wilayaToRegions.clear();
    (locations || []).forEach(item => {
      const w = item && item.wilaya ? String(item.wilaya) : '';
      if (!w) return;
      wilayaToRegions.set(w, Array.isArray(item.regions) ? item.regions : []);
      const opt = document.createElement('option');
      opt.value = w;
      wilayasList.appendChild(opt);
    });
    // If a wilaya is already typed, refresh regions list
    updateRegionsForSelectedWilaya();
  }

  function updateRegionsForSelectedWilaya() {
    if (!regionsList) return;
    regionsList.innerHTML = '';
    const w = (wilayaInput && wilayaInput.value) ? wilayaInput.value.trim() : '';
    const regions = (w && wilayaToRegions.has(w)) ? (wilayaToRegions.get(w) || []) : [];
    regions.forEach(r => {
      if (!r) return;
      const opt = document.createElement('option');
      opt.value = String(r);
      regionsList.appendChild(opt);
    });
  }

  async function fetchLocations(params) {
    const qs = new URLSearchParams(params || {});
    try {
      const url = '/api/land_locations' + (qs.toString() ? ('?' + qs.toString()) : '');
      const res = await fetch(url);
      if (!res.ok) return;
      const json = await res.json();
      populateWilayas(json && json.locations ? json.locations : []);
    } catch (_) { /* ignore */ }
  }

  function coercePositiveNumber(value) {
    const num = parseFloat(String(value || '').trim());
    return Number.isFinite(num) && num > 0 ? num : null;
  }

  function mapBankInputToSlug(raw) {
    const val = String(raw || '').trim();
    if (!val) return '';
    // If user typed a bank name instead of slug, convert to slug
    if (!bankNameBySlug.has(val) && bankSlugByName.has(val.toLowerCase())) {
      return bankSlugByName.get(val.toLowerCase());
    }
    return val; // assume already slug (from selecting an option)
  }

  // Event bindings
  if (bankInput) {
    bankInput.addEventListener('change', async () => {
      const slug = mapBankInputToSlug(bankInput.value);
      if (slug) {
        // Reflect normalized slug back into the input for consistency
        bankInput.value = slug;
        await fetchLocations({ bank: slug });
      } else {
        await fetchLocations();
      }
    });
  }

  if (wilayaInput) {
    wilayaInput.addEventListener('input', updateRegionsForSelectedWilaya);
  }

  if (continueBtn) {
    continueBtn.addEventListener('click', () => {
      const params = new URLSearchParams();
      params.set('entity', entity || 'person');
      if (purpose) params.set('purpose', purpose);

      const bankSlug = mapBankInputToSlug(bankInput && bankInput.value);
      if (bankSlug) params.set('bank', bankSlug);

      const useVal = (useInput && useInput.value) ? useInput.value.trim() : '';
      if (useVal) params.set('use', useVal);

      const wilayaVal = (wilayaInput && wilayaInput.value) ? wilayaInput.value.trim() : '';
      if (wilayaVal) params.set('wilaya', wilayaVal);

      const regionVal = (regionInput && regionInput.value) ? regionInput.value.trim() : '';
      if (regionVal) params.set('region', regionVal);

      const la = coercePositiveNumber(landAreaInput && landAreaInput.value);
      if (la !== null) params.set('land_area', String(la));

      if (buildAreaInput && purpose !== 'تثمين أرض') {
        const ba = coercePositiveNumber(buildAreaInput.value);
        if (ba !== null) params.set('build_area', String(ba));
      }

      if (buildAgeInput && purpose === 'تثمين عقار قائم') {
        const ageNum = coercePositiveNumber(buildAgeInput.value);
        if (ageNum !== null) params.set('age', String(ageNum));
      }

      const phoneVal = (phoneInput && phoneInput.value) ? phoneInput.value.trim() : '';
      if (phoneVal) params.set('phone', phoneVal);

      window.location.href = '/certified/offers?' + params.toString();
    });
  }

  // Initial load
  (async function init() {
    await fetchBanks();
    await fetchLocations();
    updateRegionsForSelectedWilaya();
  })();
})();
</script>
{% endblock %}
